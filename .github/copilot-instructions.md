# Copilot / AI Agent Instructions — NSF CURE SBP

Purpose
- Help AI coding agents be immediately productive in this mono-repo containing the Payload CMS (admin) and the Next.js `web` app.

Big picture (quick)
- Two main apps: the CMS/admin in `payload-cms/` (Payload CMS + Next.js) and the public site in `web/` (Next.js). See `docs/architecture/architecture.md` for full rationale.
- `payload-cms` exposes an admin UI at `admin.sbp.local:3000` and an API used by the `web` app (usually at `app.sbp.local:3001`). Hosts are configured in `scripts/dev-setup.sh`.
- Postgres is the primary datastore via `@payloadcms/db-postgres` configured in `payload-cms/src/payload.config.ts`.

Key developer flows & commands
- Install: run `pnpm install` in both `payload-cms/` and `web/` (pnpm workspace-aware). Node engines in root `package.json` indicate supported Node versions.
- Dev (CMS/admin): `cd payload-cms && pnpm dev` (listens on `admin.sbp.local:3000`). Dev uses `next dev` with host flags in `payload-cms/package.json`.
- Dev (web): `cd web && pnpm dev` (listens on `app.sbp.local:3001`).
- Add local hosts: run `./scripts/dev-setup.sh` (requires `sudo`) to add `preview.sbp.local`, `app.sbp.local`, `admin.sbp.local` to `/etc/hosts`.
- Build / start: use the `build` / `start` scripts in each package.json. Root `package.json` includes combined test commands.
- Generate helpers: `pnpm generate:types` and `pnpm generate:importmap` (run in `payload-cms`) — these are important when adding admin `views` or custom components.
- Tests: unit/integration via `vitest` (`pnpm run test:int`) and E2E via Playwright (`pnpm run test:e2e`). See root `package.json` scripts.

Where to look for concrete examples
- Payload config: `payload-cms/src/payload.config.ts` — central place for collections, globals, endpoints, email adapter, DB adapter, and admin components.
- Collections: `payload-cms/src/collections/*` — data models and access patterns. Example: `Users.ts` shows roles (`admin|professor|staff`) and `access` functions using `req.user`.
- Endpoints: `payload-cms/src/endpoints/*` — small handlers returning `Response` objects; registered via the `endpoints` array in `payload.config.ts` (example: `accountsMeHandler` in `endpoints/accountsMe.ts`).
- Views & admin components: `payload-cms/src/views/*` — referenced via the import map entries in `payload.config.ts`.
- Migrations: `payload-cms/src/migrations/` — JSON/TS migrations applied to the DB.

# Copilot / AI Agent Instructions — NSF CURE SBP

Purpose
- Help AI coding agents and new contributors be immediately productive in this mono-repo containing the Payload CMS (admin) and the Next.js `web` app.

Quick architecture (1-paragraph)
- Two primary apps: `payload-cms/` (Payload CMS + Next.js admin + API) and `web/` (the public Next.js site). The CMS hosts admin UI and API endpoints; the `web` app consumes that API. Postgres is the canonical DB and `@payloadcms/db-postgres` is configured in `payload-cms/src/payload.config.ts`.

Essential developer flows (copyable commands)
- Install deps (repo root):
```bash
cd payload-cms && pnpm install
cd ../web && pnpm install
```
- Start CMS (dev):
```bash
cd payload-cms && pnpm dev
# admin available at http://admin.sbp.local:3000
```
- Start web (dev):
```bash
cd web && pnpm dev
# site available at http://app.sbp.local:3001
```
- Hosts: run `./scripts/dev-setup.sh` (requires `sudo`) to add required local hostnames.
- Generate helpers (after schema or view changes):
```bash
cd payload-cms && pnpm generate:types
cd payload-cms && pnpm generate:importmap
```

Key files & patterns (where to look)
- `payload-cms/src/payload.config.ts`: central config — DB adapter, email adapter, `collections`, `globals`, `endpoints`, `admin.importMap`.
- `payload-cms/src/collections/*`: collection schemas and `access` rules. See `Users.ts` for cookie, role, and `access` patterns.
- `payload-cms/src/endpoints/*`: small HTTP handlers (export functions accepting `PayloadRequest` and returning `Response`). Registered in `payload.config.ts` under `endpoints`.
- `payload-cms/src/views/*`: custom admin views/components referenced via import map paths like `@/views/StaffDashboardView#default`.
- `payload-cms/src/migrations/*`: migration files (JSON/TS). Follow existing naming/timestamp patterns when adding migrations.

Repository conventions / patterns
- Auth & access: Collections often check `req.user` for authorization; prefer reusing collection-level `access` patterns (see `Users.ts`).
- Endpoints pattern: handlers accept `PayloadRequest` and return `Response` objects (use `new Response(JSON.stringify(...))` as in `accountsMe`). Register new endpoints in `payload.config.ts`.
- Email: `nodemailer` adapter is created in `payload.config.ts` using `SMTP_*` env vars. Use the same adapter pattern when sending programmatic emails.
- Generated types: `payload-cms/src/payload-types.ts` is generated by `payload generate:types` and used by other repo files — run generator after schema changes.

Environment & secrets (practical notes)
- `payload-cms/.env` keys of interest: `DATABASE_URI`, `PAYLOAD_SECRET`, `PAYLOAD_PUBLIC_SERVER_URL`, `FRONTEND_URL`, `PREVIEW_SECRET`, and `SMTP_*` variables used by the Nodemailer adapter in `payload.config.ts`.
- `web/.env.local` keys: `NEXT_PUBLIC_PAYLOAD_URL`, `NEXT_PUBLIC_SITE_URL`.
- Cookie behavior: `Users.ts` sets cookie `secure` and `domain` from env. When debugging auth/session issues, confirm these env vars.

Adding features: concrete examples
- Add a collection: create `payload-cms/src/collections/MyThing.ts` exporting a `CollectionConfig`, then add it to the `collections` array in `payload-cms/src/payload.config.ts`. Run `pnpm generate:types` after migrations/schema changes.
- Add an endpoint: create `payload-cms/src/endpoints/myEndpoint.ts`:
```ts
import type { PayloadRequest } from 'payload'
export const myHandler = async (req: PayloadRequest) => new Response(JSON.stringify({ ok: true }))
```
then register `{ path: '/my-endpoint', method: 'get', handler: myHandler }` in `payload.config.ts`.
- Add admin view: create component under `payload-cms/src/views/`, update importmap with `pnpm generate:importmap`, then reference via `admin.importMap` in `payload.config.ts`.

Migrations & types
- Migrations: `payload-cms/src/migrations/` — use timestamp prefix (see existing files like `20260105_120000_add_professor_role.ts`). Keep migrations descriptive and idempotent where possible.
- After changing collections or running migrations, regenerate TS helpers: `cd payload-cms && pnpm generate:types`.

Testing & CI
- Unit/Integration: `pnpm run test:int` (uses `vitest`).
- E2E: `pnpm run test:e2e` (Playwright). If tests fail due to missing browsers, run `pnpm exec playwright install`.
- Root `package.json` defines combined `test` script used by CI.

Local Postgres (fast setup)
- Simple Docker Compose snippet you can use for local dev (create `docker-compose.pg.yml`):
```yaml
version: '3.8'
services:
	db:
		image: postgres:15
		environment:
			POSTGRES_USER: payload
			POSTGRES_PASSWORD: payload
			POSTGRES_DB: payload_db
		ports:
			- '5432:5432'
		volumes:
			- pgdata:/var/lib/postgresql/data
volumes:
	pgdata:
```
Set `DATABASE_URI=postgres://payload:payload@localhost:5432/payload_db` in `payload-cms/.env`.

Troubleshooting (common failures and quick fixes)
- DB connection errors: confirm `DATABASE_URI` and that Postgres is running. Use the docker-compose snippet above for a fast local DB.
- Email issues: check `SMTP_HOST/PORT/USER/PASS` in `payload-cms/.env`. For dev testing, use a local SMTP dev server (`smtp4dev`) or log email via the adapter.
- Cookie/session issues: run `./scripts/dev-setup.sh` and clear cookies for `admin.sbp.local` and `app.sbp.local`.
- macOS sharp errors: ensure Node matches `engines` in `package.json` and re-run `pnpm install` (the repo has `pnpm.overrides` to help on macOS).

Code style & formatting
- Use the root `format` script (`prettier`) to format files: `pnpm run format`.

Where to ask for clarification
- If unsure whether a change belongs in `payload-cms` or `web`, ask which app will own the data/API surface. For schema changes, ask whether a migration is required and whether types should be regenerated.

Short checklist before PRs touching schema or admin UX
- Add migration file (if schema changes).
- Run `pnpm generate:types` and commit the updated `payload-types.ts` when required.
- If adding or moving admin views, run `pnpm generate:importmap` and include import map changes.

Docs & further reading
- `docs/architecture/architecture.md`, `docs/developers/data-models.md`, `docs/operations/deployment.md`.

If you want more detail on any area (CI config, an example migration, or an admin-view walkthrough) tell me which one and I will add a short, runnable example.
